<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch AI - Advanced Movie Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .movie-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }
        .movie-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .genre-tag, .language-tag {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .genre-tag:hover, .language-tag:hover {
            transform: translateY(-2px);
        }
        .genre-tag.selected, .language-tag.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .match-score {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .watched-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .flag-emoji {
            font-size: 1.2em;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-16 fade-in-up">
            <div class="inline-block mb-4">
                <div class="text-6xl mb-2">üé¨</div>
            </div>
            <h1 class="text-6xl font-extrabold mb-4 tracking-tight">
                <span class="gradient-text">CineMatch AI Pro</span>
            </h1>
            <p class="text-xl text-blue-200 font-light">Discover New Movies You Haven't Seen</p>
            <div class="flex items-center justify-center gap-3 mt-4">
                <span class="px-4 py-2 rounded-full text-sm font-semibold bg-green-500/20 border border-green-400/50 text-green-200">
                    üß† Advanced AI
                </span>
                <span class="px-4 py-2 rounded-full text-sm font-semibold bg-purple-500/20 border border-purple-400/50 text-purple-200">
                    üåç All Languages
                </span>
                <span class="px-4 py-2 rounded-full text-sm font-semibold bg-orange-500/20 border border-orange-400/50 text-orange-200">
                    ‚úÖ Watched List
                </span>
            </div>
        </div>

        <!-- API Key Setup -->
        <div id="apiKeySection" class="max-w-2xl mx-auto mb-12 fade-in-up">
            <div class="glass-effect rounded-3xl p-8 shadow-2xl">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                        <span class="text-2xl">üîë</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Get Your Free TMDB API Key</h2>
                        <p class="text-blue-200 text-sm">Free forever ‚Ä¢ No payment needed</p>
                    </div>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-400/30 rounded-2xl p-6 mb-6">
                    <p class="text-sm text-blue-200 mb-3 font-semibold">Quick Setup:</p>
                    <ol class="text-sm text-blue-100 space-y-2">
                        <li>1. Visit <a href="https://www.themoviedb.org/signup" target="_blank" class="text-blue-300 underline">themoviedb.org/signup</a></li>
                        <li>2. Settings ‚Üí API ‚Üí Request API Key</li>
                        <li>3. Copy your API Key (v3 auth)</li>
                    </ol>
                </div>

                <div class="space-y-4">
                    <input type="text" id="apiKeyInput" 
                           placeholder="Paste your TMDB API key..."
                           class="w-full px-6 py-4 rounded-xl bg-white/5 border border-white/20 text-white placeholder-blue-400/40 focus:border-blue-400 focus:outline-none">
                    <button id="saveApiKey" 
                            class="w-full py-4 btn-primary rounded-xl font-semibold text-lg shadow-lg">
                        Start Discovering ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- AI Status -->
            <div id="aiStatus" class="hidden glass-effect rounded-2xl p-4 mb-6 border border-green-400/30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                        <p class="text-sm text-green-200">
                            <span class="font-semibold">üß† AI Learning:</span> 
                            <span id="aiStats">Building your profile...</span>
                        </p>
                    </div>
                    <button id="resetAI" class="text-xs text-green-300 hover:text-green-100 underline">Reset</button>
                </div>
            </div>

            <!-- Watched Movies Counter -->
            <div class="glass-effect rounded-2xl p-4 mb-6 border border-orange-400/30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">‚úÖ</span>
                        <p class="text-sm text-orange-200">
                            <span class="font-semibold">Watched:</span> 
                            <span id="watchedCount">0 movies</span>
                        </p>
                    </div>
                    <button id="manageWatched" class="text-sm px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 rounded-lg border border-orange-400/50">
                        Manage List
                    </button>
                </div>
            </div>

            <!-- Main Input Section -->
            <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl fade-in-up">
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Tell Me What You've Watched</h2>
                            <p class="text-blue-200 text-sm">I'll find NEW movies you haven't seen</p>
                        </div>
                    </div>
                    <button id="changeApiKey" class="text-sm text-blue-300 hover:text-blue-100 px-4 py-2 rounded-lg hover:bg-white/5">
                        Change Key
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Search Watched Movies -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">
                            <span class="text-xl mr-2">üé¨</span>
                            Add Movies You've Already Watched
                        </label>
                        <div class="relative">
                            <input type="text" id="movieSearch" 
                                   placeholder="Search movies you've watched... (e.g., Inception, Parasite, 3 Idiots)"
                                   class="w-full px-6 py-4 rounded-xl bg-white/5 border border-white/20 text-white placeholder-blue-300/50 focus:border-blue-400 focus:outline-none">
                            <div id="searchResults" class="absolute w-full mt-2 hidden z-10"></div>
                        </div>
                        <div id="watchedMovies" class="flex flex-wrap gap-2 mt-3"></div>
                        <p class="text-xs text-blue-300/60 mt-2">üí° Add 5-10 movies you've watched and enjoyed</p>
                    </div>

                    <!-- Language Selection -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">
                            <span class="text-xl mr-2">üåç</span>
                            Languages (Select All You're Interested In)
                        </label>
                        <div class="flex flex-wrap gap-3" id="languageContainer"></div>
                    </div>

                    <!-- Preferred Genres -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">
                            <span class="text-xl mr-2">üé≠</span>
                            Preferred Genres
                        </label>
                        <div class="flex flex-wrap gap-3" id="genreContainer"></div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="bg-white/5 rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-blue-100 mb-4">Advanced Options</h3>
                        
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm">
                                <span class="mr-2">üéì</span>Include lesser-known films
                            </span>
                            <input type="checkbox" id="includeHidden" class="rounded" checked>
                        </label>
                        
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm">
                                <span class="mr-2">üÜï</span>Prefer recent movies (2015+)
                            </span>
                            <input type="checkbox" id="preferRecent" class="rounded">
                        </label>
                        
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm">
                                <span class="mr-2">‚≠ê</span>Only highly-rated (8.0+)
                            </span>
                            <input type="checkbox" id="onlyHighRated" class="rounded">
                        </label>
                    </div>

                    <!-- Get Recommendations Button -->
                    <button id="getRecommendations" 
                            class="w-full py-5 btn-primary rounded-xl font-bold text-lg shadow-2xl disabled:opacity-50">
                        <span class="flex items-center justify-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Discover NEW Movies For Me!
                        </span>
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden glass-effect border-2 border-red-400/50 rounded-2xl p-6 mb-8">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-red-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-200 font-medium"></p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-16">
                <div class="inline-block">
                    <div class="w-20 h-20 border-4 border-blue-400/30 border-t-blue-400 rounded-full animate-spin mb-6"></div>
                    <p class="text-2xl font-semibold loading-dots text-blue-200">AI is finding NEW movies</p>
                    <p class="text-sm text-blue-300/60 mt-2">Analyzing 500,000+ films across all languages...</p>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div id="recommendationsSection" class="hidden fade-in-up">
                <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <div class="flex items-start mb-4">
                        <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                            <span class="text-xl">‚ú®</span>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold mb-3">Fresh Discoveries Just For You</h2>
                            <p id="recommendationReasoning" class="text-blue-100 leading-relaxed text-lg"></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="movieCards"></div>

                <div class="text-center space-x-4">
                    <button id="loadMore" class="px-8 py-4 btn-primary rounded-xl font-semibold shadow-lg">
                        Show More Discoveries
                    </button>
                    <button id="refreshRecs" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-xl font-semibold shadow-lg">
                        üîÑ Get Different Movies
                    </button>
                </div>
            </div>

            <!-- Watched List Modal -->
            <div id="watchedModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div class="glass-effect rounded-3xl p-8 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Your Watched Movies</h2>
                        <button id="closeModal" class="text-blue-300 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div id="watchedList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
        
        let apiKey = localStorage.getItem('tmdb_api_key');
        let selectedGenres = [];
        let selectedLanguages = ['en']; // Default English
        let watchedMovieIds = [];
        let watchedMoviesData = [];
        let recommendationPool = [];
        let displayedRecommendations = 0;
        
        // Enhanced AI Learning System
        class AdvancedMovieAI {
            constructor() {
                this.watchedMovies = this.loadWatched();
                this.ratings = this.loadRatings();
                this.genreWeights = this.loadGenreWeights();
                this.languagePrefs = this.loadLanguagePrefs();
                this.directorPrefs = this.loadDirectorPrefs();
            }

            loadWatched() {
                const saved = localStorage.getItem('watched_movies');
                return saved ? JSON.parse(saved) : [];
            }

            loadRatings() {
                const saved = localStorage.getItem('movie_ratings_v2');
                return saved ? JSON.parse(saved) : [];
            }

            loadGenreWeights() {
                const saved = localStorage.getItem('genre_weights_v2');
                return saved ? JSON.parse(saved) : {};
            }

            loadLanguagePrefs() {
                const saved = localStorage.getItem('language_prefs');
                return saved ? JSON.parse(saved) : { 'en': 1.0 };
            }

            loadDirectorPrefs() {
                const saved = localStorage.getItem('director_prefs');
                return saved ? JSON.parse(saved) : {};
            }

            saveData() {
                localStorage.setItem('watched_movies', JSON.stringify(this.watchedMovies));
                localStorage.setItem('movie_ratings_v2', JSON.stringify(this.ratings));
                localStorage.setItem('genre_weights_v2', JSON.stringify(this.genreWeights));
                localStorage.setItem('language_prefs', JSON.stringify(this.languagePrefs));
                localStorage.setItem('director_prefs', JSON.stringify(this.directorPrefs));
            }

            addWatched(movieId, genres, language, director) {
                if (!this.watchedMovies.includes(movieId)) {
                    this.watchedMovies.push(movieId);
                    
                    // Update genre weights based on watched
                    genres.forEach(genreId => {
                        if (!this.genreWeights[genreId]) {
                            this.genreWeights[genreId] = 0.5;
                        }
                        this.genreWeights[genreId] = Math.min(1.0, this.genreWeights[genreId] + 0.05);
                    });
                    
                    // Update language preference
                    if (!this.languagePrefs[language]) {
                        this.languagePrefs[language] = 0.5;
                    }
                    this.languagePrefs[language] = Math.min(1.0, this.languagePrefs[language] + 0.1);
                    
                    // Update director preference
                    if (director) {
                        if (!this.directorPrefs[director]) {
                            this.directorPrefs[director] = 0.5;
                        }
                        this.directorPrefs[director] = Math.min(1.0, this.directorPrefs[director] + 0.1);
                    }
                    
                    this.saveData();
                }
            }

            rateMovie(movieId, genres, language, director, rating) {
                this.ratings.push({ movieId, genres, language, director, rating, timestamp: Date.now() });
                
                // Stronger weight updates for explicit ratings
                genres.forEach(genreId => {
                    if (!this.genreWeights[genreId]) {
                        this.genreWeights[genreId] = 0.5;
                    }
                    
                    if (rating === 1) {
                        this.genreWeights[genreId] = Math.min(1.0, this.genreWeights[genreId] + 0.15);
                    } else {
                        this.genreWeights[genreId] = Math.max(0.0, this.genreWeights[genreId] - 0.1);
                    }
                });
                
                // Language preference
                if (rating === 1) {
                    if (!this.languagePrefs[language]) {
                        this.languagePrefs[language] = 0.5;
                    }
                    this.languagePrefs[language] = Math.min(1.0, this.languagePrefs[language] + 0.15);
                }
                
                // Director preference
                if (director && rating === 1) {
                    if (!this.directorPrefs[director]) {
                        this.directorPrefs[director] = 0.5;
                    }
                    this.directorPrefs[director] = Math.min(1.0, this.directorPrefs[director] + 0.2);
                }
                
                this.saveData();
                this.updateStatus();
            }

            calculateAdvancedScore(movie, watchedMovies) {
                let score = 0;
                
                // Base rating (0-20)
                score += movie.vote_average * 2;
                
                // Popularity (0-15)
                score += Math.min(15, (movie.popularity / 80));
                
                // Genre matching with AI weights (0-35)
                let genreScore = 0;
                movie.genre_ids.forEach(genreId => {
                    const weight = this.genreWeights[genreId] || 0.5;
                    genreScore += weight * 10;
                });
                score += Math.min(35, genreScore);
                
                // Language preference (0-10)
                const langWeight = this.languagePrefs[movie.original_language] || 0.3;
                score += langWeight * 10;
                
                // Similarity to watched (0-15)
                const overlap = movie.genre_ids.filter(g => 
                    watchedMovies.some(wm => wm.genre_ids && wm.genre_ids.includes(g))
                ).length;
                score += Math.min(15, overlap * 3);
                
                // Vote count confidence (0-5)
                if (movie.vote_count > 1000) score += 5;
                else if (movie.vote_count > 500) score += 3;
                else if (movie.vote_count > 100) score += 1;
                
                return score;
            }

            updateStatus() {
                const statusEl = document.getElementById('aiStatus');
                const statsEl = document.getElementById('aiStats');
                
                if (this.ratings.length > 0 || this.watchedMovies.length > 0) {
                    statusEl.classList.remove('hidden');
                    const likes = this.ratings.filter(r => r.rating === 1).length;
                    const topGenres = Object.entries(this.genreWeights)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 2)
                        .map(([id, _]) => this.getGenreName(id));
                    
                    statsEl.textContent = `${this.watchedMovies.length} watched ‚Ä¢ ${likes} liked ‚Ä¢ Loves: ${topGenres.join(', ')}`;
                }
            }

            getGenreName(id) {
                const genres = {
                    28: 'Action', 35: 'Comedy', 18: 'Drama', 878: 'Sci-Fi',
                    27: 'Horror', 10749: 'Romance', 53: 'Thriller', 16: 'Animation'
                };
                return genres[id] || 'Unknown';
            }

            reset() {
                localStorage.removeItem('watched_movies');
                localStorage.removeItem('movie_ratings_v2');
                localStorage.removeItem('genre_weights_v2');
                localStorage.removeItem('language_prefs');
                localStorage.removeItem('director_prefs');
                this.watchedMovies = [];
                this.ratings = [];
                this.genreWeights = {};
                this.languagePrefs = { 'en': 1.0 };
                this.directorPrefs = {};
                location.reload();
            }
        }

        const aiSystem = new AdvancedMovieAI();

        // Languages with flags
        const LANGUAGES = {
            'en': { name: 'English', flag: 'üá∫üá∏' },
            'es': { name: 'Spanish', flag: 'üá™üá∏' },
            'fr': { name: 'French', flag: 'üá´üá∑' },
            'de': { name: 'German', flag: 'üá©üá™' },
            'it': { name: 'Italian', flag: 'üáÆüáπ' },
            'ja': { name: 'Japanese', flag: 'üáØüáµ' },
            'ko': { name: 'Korean', flag: 'üá∞üá∑' },
            'zh': { name: 'Chinese', flag: 'üá®üá≥' },
            'hi': { name: 'Hindi', flag: 'üáÆüá≥' },
            'ta': { name: 'Tamil', flag: 'üáÆüá≥' },
            'te': { name: 'Telugu', flag: 'üáÆüá≥' },
            'ml': { name: 'Malayalam', flag: 'üáÆüá≥' },
            'th': { name: 'Thai', flag: 'üáπüá≠' },
            'ar': { name: 'Arabic', flag: 'üá∏üá¶' },
            'ru': { name: 'Russian', flag: 'üá∑üá∫' },
            'pt': { name: 'Portuguese', flag: 'üáµüáπ' },
            'tr': { name: 'Turkish', flag: 'üáπüá∑' },
            'pl': { name: 'Polish', flag: 'üáµüá±' }
        };

        const GENRE_IDS = {
            'Action': 28, 'Adventure': 12, 'Animation': 16, 'Comedy': 35,
            'Crime': 80, 'Documentary': 99, 'Drama': 18, 'Family': 10751,
            'Fantasy': 14, 'History': 36, 'Horror': 27, 'Music': 10402,
            'Mystery': 9648, 'Romance': 10749, 'Sci-Fi': 878,
            'Thriller': 53, 'War': 10752, 'Western': 37
        };

        // Initialize
        if (apiKey) {
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initializeApp();
        }

        document.getElementById('saveApiKey').addEventListener('click', async () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showError('Please enter your TMDB API key');
                return;
            }
            
            try {
                const response = await fetch(`${TMDB_BASE_URL}/movie/popular?api_key=${key}`);
                if (!response.ok) throw new Error('Invalid');
                
                localStorage.setItem('tmdb_api_key', key);
                apiKey = key;
                
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeApp();
            } catch (error) {
                showError('Invalid API key');
            }
        });

        document.getElementById('changeApiKey').addEventListener('click', () => {
            if (confirm('Change API key?')) {
                localStorage.removeItem('tmdb_api_key');
                location.reload();
            }
        });

        document.getElementById('resetAI').addEventListener('click', () => {
            if (confirm('Reset all AI learning data?')) {
                aiSystem.reset();
            }
        });

        async function initializeApp() {
            loadLanguages();
            loadGenres();
            setupMovieSearch();
            loadWatchedMovies();
            aiSystem.updateStatus();
        }

        function loadLanguages() {
            const container = document.getElementById('languageContainer');
            
            Object.entries(LANGUAGES).forEach(([code, info]) => {
                const tag = document.createElement('button');
                tag.className = 'language-tag px-4 py-2 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium';
                tag.innerHTML = `<span class="flag-emoji">${info.flag}</span> ${info.name}`;
                tag.dataset.code = code;
                
                if (code === 'en') tag.classList.add('selected');
                
                tag.addEventListener('click', () => {
                    const langCode = tag.dataset.code;
                    if (selectedLanguages.includes(langCode)) {
                        selectedLanguages = selectedLanguages.filter(l => l !== langCode);
                        tag.classList.remove('selected');
                    } else {
                        selectedLanguages.push(langCode);
                        tag.classList.add('selected');
                    }
                });
                
                container.appendChild(tag);
            });
        }

        function loadGenres() {
            const container = document.getElementById('genreContainer');
            
            Object.keys(GENRE_IDS).forEach(genre => {
                const tag = document.createElement('button');
                tag.className = 'genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium';
                tag.textContent = genre;
                tag.dataset.id = GENRE_IDS[genre];
                
                tag.addEventListener('click', () => {
                    const genreId = parseInt(tag.dataset.id);
                    if (selectedGenres.includes(genreId)) {
                        selectedGenres = selectedGenres.filter(g => g !== genreId);
                        tag.classList.remove('selected');
                    } else {
                        selectedGenres.push(genreId);
                        tag.classList.add('selected');
                    }
                });
                
                container.appendChild(tag);
            });
        }

        let searchTimeout;
        function setupMovieSearch() {
            const searchInput = document.getElementById('movieSearch');
            const searchResults = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const movies = await searchMovies(query);
                    displaySearchResults(movies);
                }, 300);
            });
        }

        async function searchMovies(query) {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}&page=1`);
                const data = await response.json();
                return data.results.slice(0, 8);
            } catch (error) {
                return [];
            }
        }

        function displaySearchResults(movies) {
            const searchResults = document.getElementById('searchResults');
            
            if (movies.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            
            searchResults.innerHTML = movies.map(movie => {
                const langInfo = LANGUAGES[movie.original_language] || { flag: 'üé¨', name: movie.original_language };
                return `
                    <div class="bg-slate-800 hover:bg-slate-700 p-3 cursor-pointer border-b border-slate-600 last:border-0 rounded-xl"
                         onclick="addWatchedMovie(${movie.id}, '${movie.title.replace(/'/g, "\\'")}', '${movie.release_date?.substring(0, 4) || 'N/A'}', ${JSON.stringify(movie.genre_ids)}, '${movie.original_language}')">
                        <div class="flex justify-between">
                            <div class="flex-1">
                                <div class="font-semibold">${movie.title}</div>
                                <div class="text-xs text-slate-400">${langInfo.flag} ${langInfo.name} ‚Ä¢ ${movie.release_date?.substring(0, 4) || 'N/A'} ‚Ä¢ ‚≠ê ${movie.vote_average.toFixed(1)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            searchResults.classList.remove('hidden');
        }

        function addWatchedMovie(id, title, year, genreIds, language) {
            if (watchedMovieIds.includes(id)) return;
            
            watchedMovieIds.push(id);
            watchedMoviesData.push({ id, title, year, genre_ids: genreIds, original_language: language });
            aiSystem.addWatched(id, genreIds, language, null);
            
            updateWatchedDisplay();
            updateWatchedCount();
            
            document.getElementById('movieSearch').value = '';
            document.getElementById('searchResults').classList.add('hidden');
        }

        window.addWatchedMovie = addWatchedMovie;

        function updateWatchedDisplay() {
            const container = document.getElementById('watchedMovies');
            container.innerHTML = '';
            
            watchedMoviesData.forEach(movie => {
                const langInfo = LANGUAGES[movie.original_language] || { flag: 'üé¨' };
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center gap-2 px-4 py-2 watched-badge rounded-lg shadow-lg';
                tag.innerHTML = `
                    <span class="text-sm font-semibold">${langInfo.flag} ${movie.title} (${movie.year})</span>
                    <button onclick="removeWatchedMovie(${movie.id})" class="text-white hover:text-orange-200">√ó</button>
                `;
                container.appendChild(tag);
            });
        }

        window.removeWatchedMovie = function(id) {
            watchedMovieIds = watchedMovieIds.filter(m => m !== id);
            watchedMoviesData = watchedMoviesData.filter(m => m.id !== id);
            updateWatchedDisplay();
            updateWatchedCount();
        };

        function updateWatchedCount() {
            document.getElementById('watchedCount').textContent = `${watchedMovieIds.length} movies`;
        }

        function loadWatchedMovies() {
            const saved = aiSystem.loadWatched();
            if (saved.length > 0) {
                watchedMovieIds = saved;
                updateWatchedCount();
            }
        }

        // Manage watched list
        document.getElementById('manageWatched').addEventListener('click', () => {
            document.getElementById('watchedModal').classList.remove('hidden');
            displayWatchedList();
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('watchedModal').classList.add('hidden');
        });

        async function displayWatchedList() {
            const container = document.getElementById('watchedList');
            container.innerHTML = '<p class="col-span-full text-center text-blue-200">Loading...</p>';
            
            if (watchedMovieIds.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-blue-200">No watched movies yet</p>';
                return;
            }
            
            container.innerHTML = '';
            for (const id of watchedMovieIds.slice(0, 30)) {
                try {
                    const response = await fetch(`${TMDB_BASE_URL}/movie/${id}?api_key=${apiKey}`);
                    const movie = await response.json();
                    
                    const poster = movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Poster';
                    
                    const div = document.createElement('div');
                    div.className = 'bg-white/5 rounded-xl p-3';
                    div.innerHTML = `
                        <img src="${poster}" class="w-full h-48 object-cover rounded-lg mb-2">
                        <p class="text-sm font-semibold">${movie.title}</p>
                        <p class="text-xs text-blue-300">${movie.release_date?.substring(0, 4)}</p>
                    `;
                    container.appendChild(div);
                } catch (error) {
                    console.error('Error loading movie:', error);
                }
            }
        }

        // Get Recommendations
        document.getElementById('getRecommendations').addEventListener('click', async () => {
            if (watchedMovieIds.length === 0) {
                showError('Please add at least 3 movies you\'ve watched');
                return;
            }
            
            await getRecommendations();
        });

        async function getRecommendations() {
            showLoading();
            hideError();
            
            try {
                const includeHidden = document.getElementById('includeHidden').checked;
                const preferRecent = document.getElementById('preferRecent').checked;
                const onlyHighRated = document.getElementById('onlyHighRated').checked;
                
                const allRecommendations = [];
                
                // Get discover movies by selected languages
                for (const lang of selectedLanguages) {
                    for (let page = 1; page <= 3; page++) {
                        const discover = await fetch(
                            `${TMDB_BASE_URL}/discover/movie?api_key=${apiKey}&language=en-US&sort_by=vote_average.desc&vote_count.gte=100&with_original_language=${lang}&page=${page}`
                        );
                        const discoverData = await discover.json();
                        allRecommendations.push(...discoverData.results);
                    }
                }
                
                // Get similar and recommended for each watched movie (sample)
                const sampleWatched = watchedMovieIds.slice(0, 5);
                for (const movieId of sampleWatched) {
                    const similar = await fetch(`${TMDB_BASE_URL}/movie/${movieId}/similar?api_key=${apiKey}&page=1`);
                    const similarData = await similar.json();
                    allRecommendations.push(...similarData.results);
                    
                    const recommended = await fetch(`${TMDB_BASE_URL}/movie/${movieId}/recommendations?api_key=${apiKey}&page=1`);
                    const recommendedData = await recommended.json();
                    allRecommendations.push(...recommendedData.results);
                }
                
                // CRITICAL: Filter out watched movies
                let filtered = allRecommendations.filter(m => !watchedMovieIds.includes(m.id));
                
                // Filter by languages
                filtered = filtered.filter(m => selectedLanguages.includes(m.original_language));
                
                // Filter by genres if selected
                if (selectedGenres.length > 0) {
                    filtered = filtered.filter(movie => 
                        movie.genre_ids.some(g => selectedGenres.includes(g))
                    );
                }
                
                // Quality filters
                if (!includeHidden) {
                    filtered = filtered.filter(m => m.vote_average >= 6.5 && m.vote_count >= 100);
                }
                
                if (preferRecent) {
                    filtered = filtered.filter(m => {
                        const year = parseInt(m.release_date?.substring(0, 4) || '0');
                        return year >= 2015;
                    });
                }
                
                if (onlyHighRated) {
                    filtered = filtered.filter(m => m.vote_average >= 8.0);
                }
                
                // Remove duplicates
                const unique = Array.from(new Map(filtered.map(m => [m.id, m])).values());
                
                // AI scoring
                unique.forEach(movie => {
                    movie.aiScore = aiSystem.calculateAdvancedScore(movie, watchedMoviesData);
                });
                
                // Sort by AI score
                const sorted = unique.sort((a, b) => b.aiScore - a.aiScore);
                
                recommendationPool = sorted;
                displayedRecommendations = 0;
                
                if (recommendationPool.length === 0) {
                    hideLoading();
                    showError('No new movies found with your criteria. Try adjusting your filters!');
                    return;
                }
                
                displayRecommendations(12);
                
            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showError('Failed to get recommendations. Please try again.');
            }
        }

        async function displayRecommendations(count) {
            hideLoading();
            
            const toDisplay = recommendationPool.slice(displayedRecommendations, displayedRecommendations + count);
            displayedRecommendations += count;
            
            if (displayedRecommendations === count) {
                const languages = [...new Set(toDisplay.map(m => LANGUAGES[m.original_language]?.name || m.original_language))].join(', ');
                const reasoning = `Found ${recommendationPool.length} NEW movies you haven't seen! Including ${languages} cinema. All personalized by AI based on your taste.`;
                document.getElementById('recommendationReasoning').textContent = reasoning;
                document.getElementById('movieCards').innerHTML = '';
            }
            
            const movieCards = document.getElementById('movieCards');
            
            const detailedMovies = await Promise.all(
                toDisplay.map(movie => getMovieDetails(movie.id, movie.aiScore))
            );
            
            detailedMovies.forEach((movie, index) => {
                const card = createMovieCard(movie, displayedRecommendations - count + index);
                movieCards.appendChild(card);
            });
            
            document.getElementById('loadMore').style.display = 
                displayedRecommendations < recommendationPool.length ? 'inline-block' : 'none';
            
            document.getElementById('recommendationsSection').classList.remove('hidden');
            if (displayedRecommendations === count) {
                document.getElementById('recommendationsSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        document.getElementById('loadMore').addEventListener('click', () => {
            displayRecommendations(12);
        });

        document.getElementById('refreshRecs').addEventListener('click', () => {
            // Shuffle and reset
            recommendationPool.sort(() => Math.random() - 0.5);
            displayedRecommendations = 0;
            displayRecommendations(12);
        });

        async function getMovieDetails(movieId, aiScore) {
            const response = await fetch(`${TMDB_BASE_URL}/movie/${movieId}?api_key=${apiKey}&append_to_response=credits,watch/providers`);
            const movie = await response.json();
            movie.aiScore = aiScore;
            return movie;
        }

        function createMovieCard(movie, index) {
            const card = document.createElement('div');
            card.className = 'movie-card glass-effect rounded-2xl overflow-hidden shadow-xl';
            
            const poster = movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Poster';
            const genres = movie.genres.map(g => g.name).join(', ');
            const runtime = movie.runtime ? `${movie.runtime} min` : 'N/A';
            const director = movie.credits?.crew?.find(c => c.job === 'Director')?.name || 'Unknown';
            const matchScore = Math.min(99, Math.round(movie.aiScore));
            const langInfo = LANGUAGES[movie.original_language] || { flag: 'üé¨', name: movie.original_language };
            
            const providers = movie['watch/providers']?.results?.US?.flatrate || [];
            const streamingHTML = providers.length > 0 
                ? providers.slice(0, 3).map(p => 
                    `<span class="inline-block px-3 py-1 bg-blue-600 rounded-lg text-xs font-semibold mr-2 mb-2">${p.provider_name}</span>`
                ).join('')
                : '<span class="text-xs text-blue-300/60">Check availability</span>';
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${poster}" alt="${movie.title}" class="w-full h-64 object-cover">
                    <div class="absolute top-2 right-2 match-score px-3 py-1 rounded-full text-xs font-bold">
                        ${matchScore}% Match
                    </div>
                    <div class="absolute top-2 left-2 bg-black/70 px-3 py-1 rounded-full text-sm font-bold">
                        ${langInfo.flag} ${langInfo.name}
                    </div>
                </div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-blue-50 flex-1">${movie.title}</h3>
                        <div class="flex items-center ml-2 px-3 py-1 bg-yellow-500/20 border border-yellow-400/50 rounded-lg">
                            <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="text-sm font-bold text-yellow-300">${movie.vote_average.toFixed(1)}</span>
                        </div>
                    </div>
                    ${movie.original_title !== movie.title ? `<p class="text-xs text-blue-300/70 mb-2">Original: ${movie.original_title}</p>` : ''}
                    <div class="flex items-center text-blue-200 text-sm mb-3 space-x-3">
                        <span>${movie.release_date?.substring(0, 4)}</span>
                        <span>‚Ä¢</span>
                        <span>${runtime}</span>
                        <span>‚Ä¢</span>
                        <span>${movie.vote_count} votes</span>
                    </div>
                    <p class="text-blue-300 text-sm mb-3">${genres}</p>
                    <p class="text-blue-100/90 mb-4 leading-relaxed line-clamp-3">${movie.overview || 'No description available.'}</p>
                    <div class="pt-4 border-t border-white/10 mb-4">
                        <p class="text-sm text-blue-200"><span class="font-semibold">Director:</span> ${director}</p>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10 mb-4">
                        <p class="text-xs text-purple-300 mb-2 font-semibold">Train AI:</p>
                        <div class="flex gap-2">
                            <button onclick="rateMovie(${movie.id}, ${JSON.stringify(movie.genres.map(g => g.id))}, '${movie.original_language}', '${director.replace(/'/g, "\\'")}', 1, ${index})" 
                                    class="rate-btn flex-1 px-4 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-400/50 rounded-lg text-sm font-semibold text-green-200">
                                üëç Love It
                            </button>
                            <button onclick="rateMovie(${movie.id}, ${JSON.stringify(movie.genres.map(g => g.id))}, '${movie.original_language}', '${director.replace(/'/g, "\\'")}', 0, ${index})" 
                                    class="rate-btn flex-1 px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/50 rounded-lg text-sm font-semibold text-red-200">
                                üëé Not For Me
                            </button>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-blue-300 mb-2 font-semibold">Streaming:</p>
                        ${streamingHTML}
                    </div>
                </div>
            `;
            
            return card;
        }

        window.rateMovie = function(movieId, genreIds, language, director, rating, cardIndex) {
            aiSystem.rateMovie(movieId, genreIds, language, director, rating);
            
            const cards = document.querySelectorAll('.movie-card');
            const card = cards[cardIndex];
            const buttons = card.querySelectorAll('.rate-btn');
            
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            });
            
            buttons[rating === 1 ? 0 : 1].innerHTML = rating === 1 ? '‚úì Noted' : '‚úì Noted';
            
            showToast(rating === 1 ? 'AI learned you love this! üéâ' : 'AI noted your preference üëç');
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('recommendationsSection').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 6000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
