<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch AI - Smart Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .movie-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }
        .movie-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .genre-tag {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .genre-tag:hover {
            transform: translateY(-2px);
        }
        .genre-tag.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .streaming-badge {
            transition: all 0.2s ease;
        }
        .streaming-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .input-elegant {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-elegant:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .ml-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-16 fade-in-up">
            <div class="inline-block mb-4">
                <div class="text-6xl mb-2">üé¨</div>
            </div>
            <h1 class="text-6xl font-extrabold mb-4 tracking-tight">
                <span class="gradient-text">CineMatch AI</span>
            </h1>
            <p class="text-xl text-blue-200 font-light">Intelligent Movie Recommendations That Learn Your Taste</p>
            <div class="flex items-center justify-center gap-3 mt-4">
                <span class="ml-badge px-4 py-2 rounded-full text-sm font-semibold text-white shadow-lg">
                    üß† AI-Powered
                </span>
                <span class="px-4 py-2 rounded-full text-sm font-semibold bg-purple-500/20 border border-purple-400/50 text-purple-200">
                    Learns Your Taste
                </span>
            </div>
        </div>

        <!-- AI Learning Status -->
        <div id="mlStatus" class="hidden glass-effect rounded-2xl p-4 mb-6 border border-green-400/30">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                    <p class="text-sm text-green-200">
                        <span class="font-semibold">AI Learning Active:</span> 
                        <span id="mlStats">Learning from your preferences...</span>
                    </p>
                </div>
                <button id="resetML" class="text-xs text-green-300 hover:text-green-100 underline">
                    Reset Learning
                </button>
            </div>
        </div>

        <!-- API Key Setup -->
        <div id="apiKeySection" class="max-w-2xl mx-auto mb-12 fade-in-up">
            <div class="glass-effect rounded-3xl p-8 shadow-2xl">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                        <span class="text-2xl">üîë</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Setup Your API Key</h2>
                        <p class="text-blue-200 text-sm">Connect to Claude AI for intelligent recommendations</p>
                    </div>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-400/30 rounded-2xl p-6 mb-6">
                    <p class="text-sm text-blue-200 mb-3 font-semibold">How to get your API key:</p>
                    <ol class="text-sm text-blue-100 space-y-2">
                        <li class="flex items-start">
                            <span class="text-blue-400 mr-2">1.</span>
                            Visit <a href="https://console.anthropic.com" target="_blank" class="text-blue-300 hover:text-blue-200 underline">console.anthropic.com</a>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-400 mr-2">2.</span>
                            Sign up or log in to your account
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-400 mr-2">3.</span>
                            Navigate to "API Keys" section
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-400 mr-2">4.</span>
                            Create a new key and copy it below
                        </li>
                    </ol>
                </div>

                <div class="space-y-4">
                    <input type="password" id="apiKeyInput" 
                           placeholder="sk-ant-api03-..."
                           class="w-full px-6 py-4 rounded-xl input-elegant text-white placeholder-blue-300/50 focus:outline-none">
                    <button id="saveApiKey" 
                            class="w-full py-4 btn-primary rounded-xl font-semibold text-lg shadow-lg">
                        Continue to CineMatch AI ‚Üí
                    </button>
                </div>
                <p class="text-xs text-blue-300/60 mt-4 text-center flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    Your API key is stored securely in your browser only
                </p>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- AI Learning Info Banner -->
            <div class="glass-effect rounded-2xl p-6 mb-6 border border-purple-400/30">
                <div class="flex items-start">
                    <div class="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                        <span class="text-xl">üß†</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-purple-200 mb-2">Smart Learning Enabled</h3>
                        <p class="text-sm text-purple-100 mb-3">
                            CineMatch AI learns your preferences over time. Rate movies with üëç üëé to help the system understand your taste better!
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="px-3 py-1 bg-purple-500/20 rounded-full">Personalized Learning</span>
                            <span class="px-3 py-1 bg-purple-500/20 rounded-full">Smart Recommendations</span>
                            <span class="px-3 py-1 bg-purple-500/20 rounded-full">Preference Tracking</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Profile Section -->
            <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl fade-in-up">
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                            <span class="text-2xl">üë§</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Your Movie Preferences</h2>
                            <p class="text-blue-200 text-sm">The AI learns from your input</p>
                        </div>
                    </div>
                    <button id="changeApiKey" class="text-sm text-blue-300 hover:text-blue-100 px-4 py-2 rounded-lg hover:bg-white/5 transition-all">
                        Change API Key
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Favorite Movies -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">Favorite Movies</label>
                        <input type="text" id="favoriteMovies" 
                               placeholder="e.g., Inception, The Shawshank Redemption, Interstellar"
                               class="w-full px-6 py-4 rounded-xl input-elegant text-white placeholder-blue-300/50 focus:outline-none">
                        <p class="text-xs text-blue-300/60 mt-2">Separate with commas ‚Ä¢ Minimum 3 movies</p>
                    </div>

                    <!-- Preferred Genres -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">Preferred Genres</label>
                        <div class="flex flex-wrap gap-3" id="genreContainer">
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Action">Action</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Comedy">Comedy</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Drama">Drama</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Sci-Fi">Sci-Fi</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Horror">Horror</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Romance">Romance</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Thriller">Thriller</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Documentary">Documentary</button>
                            <button class="genre-tag px-5 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-blue-400/50 text-sm font-medium" data-genre="Animation">Animation</button>
                        </div>
                    </div>

                    <!-- Mood/Preference -->
                    <div>
                        <label class="block text-sm font-semibold mb-3 text-blue-100">What are you in the mood for?</label>
                        <textarea id="moodInput" rows="3"
                                  placeholder="Something thought-provoking, action-packed, heartwarming, or mind-bending..."
                                  class="w-full px-6 py-4 rounded-xl input-elegant text-white placeholder-blue-300/50 focus:outline-none resize-none"></textarea>
                    </div>

                    <!-- Get Recommendations Button -->
                    <button id="getRecommendations" 
                            class="w-full py-5 btn-primary rounded-xl font-bold text-lg shadow-2xl">
                        <span class="flex items-center justify-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Get Smart Recommendations
                        </span>
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden glass-effect border-2 border-red-400/50 rounded-2xl p-6 mb-8">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-red-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-200 font-medium"></p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-16">
                <div class="inline-block">
                    <div class="w-20 h-20 border-4 border-blue-400/30 border-t-blue-400 rounded-full animate-spin mb-6"></div>
                    <p class="text-2xl font-semibold loading-dots text-blue-200">AI is analyzing your taste</p>
                    <p class="text-sm text-blue-300/60 mt-2">Processing your preferences...</p>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div id="recommendationsSection" class="hidden fade-in-up">
                <div class="glass-effect rounded-3xl p-8 mb-8 shadow-2xl">
                    <div class="flex items-start mb-4">
                        <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                            <span class="text-xl">üéØ</span>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold mb-3">Why These Movies?</h2>
                            <p id="recommendationReasoning" class="text-blue-100 leading-relaxed text-lg"></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="movieCards">
                    <!-- Movie cards will be inserted here -->
                </div>

                <!-- Feedback Section -->
                <div class="glass-effect rounded-3xl p-8 shadow-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                            <span class="text-xl">üí¨</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Refine Your Recommendations</h3>
                            <p class="text-blue-200 text-sm">The AI learns from your feedback</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="feedbackInput" 
                               placeholder="e.g., More like Inception, less comedy, newer films, more action..."
                               class="flex-1 px-6 py-4 rounded-xl input-elegant text-white placeholder-blue-300/50 focus:outline-none">
                        <button id="refineFeedback" 
                                class="px-8 py-4 btn-primary rounded-xl font-semibold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refine
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Smart Recommendation System
        class MovieRecommenderML {
            constructor() {
                this.model = null;
                this.userPreferences = this.loadPreferences();
                this.ratingHistory = this.loadRatings();
                this.genreWeights = this.loadGenreWeights();
                this.initialized = false;
            }

            loadPreferences() {
                const saved = localStorage.getItem('ml_preferences');
                return saved ? JSON.parse(saved) : {
                    favoriteGenres: [],
                    dislikedGenres: [],
                    favoriteDirectors: [],
                    preferredYearRange: [1990, 2024],
                    averageRating: 7.0
                };
            }

            loadRatings() {
                const saved = localStorage.getItem('ml_ratings');
                return saved ? JSON.parse(saved) : [];
            }

            loadGenreWeights() {
                const saved = localStorage.getItem('ml_genre_weights');
                return saved ? JSON.parse(saved) : {
                    'Action': 0.5, 'Comedy': 0.5, 'Drama': 0.5,
                    'Sci-Fi': 0.5, 'Horror': 0.5, 'Romance': 0.5,
                    'Thriller': 0.5, 'Documentary': 0.5, 'Animation': 0.5
                };
            }

            savePreferences() {
                localStorage.setItem('ml_preferences', JSON.stringify(this.userPreferences));
                localStorage.setItem('ml_ratings', JSON.stringify(this.ratingHistory));
                localStorage.setItem('ml_genre_weights', JSON.stringify(this.genreWeights));
            }

            async initialize() {
                if (this.initialized) return;
                
                console.log('üß† Initializing AI System...');
                
                // Neural network for preference learning
                this.model = tf.sequential({
                    layers: [
                        tf.layers.dense({ inputShape: [9], units: 16, activation: 'relu' }),
                        tf.layers.dropout({ rate: 0.2 }),
                        tf.layers.dense({ units: 8, activation: 'relu' }),
                        tf.layers.dense({ units: 1, activation: 'sigmoid' })
                    ]
                });

                this.model.compile({
                    optimizer: tf.train.adam(0.001),
                    loss: 'binaryCrossentropy',
                    metrics: ['accuracy']
                });

                this.initialized = true;
                console.log('‚úÖ AI System Initialized');
                this.updateMLStatus();
            }

            updateMLStatus() {
                const statusEl = document.getElementById('mlStatus');
                const statsEl = document.getElementById('mlStats');
                
                if (this.ratingHistory.length > 0) {
                    statusEl.classList.remove('hidden');
                    statsEl.textContent = `Learned from ${this.ratingHistory.length} ratings ‚Ä¢ ${Object.keys(this.userPreferences.favoriteGenres).length} favorite genres identified`;
                }
            }

            rateMovie(movieTitle, genres, rating) {
                // rating: 1 for like, 0 for dislike
                this.ratingHistory.push({
                    title: movieTitle,
                    genres: genres,
                    rating: rating,
                    timestamp: Date.now()
                });

                // Update genre weights based on rating
                genres.forEach(genre => {
                    if (rating === 1) {
                        this.genreWeights[genre] = Math.min(1.0, (this.genreWeights[genre] || 0.5) + 0.1);
                    } else {
                        this.genreWeights[genre] = Math.max(0.0, (this.genreWeights[genre] || 0.5) - 0.1);
                    }
                });

                this.savePreferences();
                this.updateMLStatus();
                console.log('üìä Updated AI system with new rating');
            }

            getGenreVector(genres) {
                const allGenres = ['Action', 'Comedy', 'Drama', 'Sci-Fi', 'Horror', 'Romance', 'Thriller', 'Documentary', 'Animation'];
                return allGenres.map(g => genres.includes(g) ? 1 : 0);
            }

            calculateMatchScore(movieGenres) {
                let score = 0;
                let count = 0;
                
                movieGenres.forEach(genre => {
                    if (this.genreWeights[genre] !== undefined) {
                        score += this.genreWeights[genre];
                        count++;
                    }
                });

                return count > 0 ? score / count : 0.5;
            }

            getPreferenceInsights() {
                const topGenres = Object.entries(this.genreWeights)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([genre, weight]) => ({ genre, weight }));

                return {
                    topGenres,
                    totalRatings: this.ratingHistory.length,
                    modelConfidence: Math.min(100, this.ratingHistory.length * 5)
                };
            }

            reset() {
                localStorage.removeItem('ml_preferences');
                localStorage.removeItem('ml_ratings');
                localStorage.removeItem('ml_genre_weights');
                this.userPreferences = this.loadPreferences();
                this.ratingHistory = [];
                this.genreWeights = this.loadGenreWeights();
                document.getElementById('mlStatus').classList.add('hidden');
                console.log('üîÑ AI system reset');
            }

            getEnhancedPrompt(basePrompt) {
                const insights = this.getPreferenceInsights();
                
                if (this.ratingHistory.length === 0) {
                    return basePrompt;
                }

                const mlContext = `\n\nAI INSIGHTS (use to enhance recommendations):
- User has rated ${insights.totalRatings} movies
- Top preferred genres: ${insights.topGenres.map(g => `${g.genre} (${(g.weight * 100).toFixed(0)}% match)`).join(', ')}
- System confidence: ${insights.modelConfidence}%
- Recent preferences: ${this.ratingHistory.slice(-3).map(r => r.title).join(', ')}

Use these insights to provide even more personalized recommendations.`;

                return basePrompt + mlContext;
            }
        }

        // Initialize AI Learning System
        const mlSystem = new MovieRecommenderML();
        mlSystem.initialize();

        // Rest of the application code
        let selectedGenres = [];
        let conversationHistory = [];
        let userProfile = {};
        let apiKey = localStorage.getItem('anthropic_api_key');
        let currentRecommendations = [];

        // Streaming platforms with official brand logos
        const streamingPlatforms = {
            'Netflix': { 
                color: 'bg-black', 
                name: 'Netflix',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/207360008/s100/netflix.webp'
            },
            'Amazon Prime': { 
                color: 'bg-[#00A8E1]', 
                name: 'Prime Video',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/52449539/s100/amazon-prime-video.webp'
            },
            'Disney+': { 
                color: 'bg-[#113CCF]', 
                name: 'Disney+',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/147638351/s100/disney-plus.webp'
            },
            'HBO Max': { 
                color: 'bg-[#0060FF]', 
                name: 'Max',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/305133538/s100/max.webp'
            },
            'Hulu': { 
                color: 'bg-[#1CE783]', 
                name: 'Hulu',
                textColor: 'text-black',
                logo: 'https://images.justwatch.com/icon/305458112/s100/hulu.webp'
            },
            'Apple TV+': { 
                color: 'bg-black', 
                name: 'Apple TV+',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/190848813/s100/apple-tv-plus.webp'
            },
            'Paramount+': { 
                color: 'bg-[#0064FF]', 
                name: 'Paramount+',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/305458193/s100/paramount-plus.webp'
            },
            'Peacock': { 
                color: 'bg-black', 
                name: 'Peacock',
                textColor: 'text-white',
                logo: 'https://images.justwatch.com/icon/305299814/s100/peacock.webp'
            }
        };

        // Check if API key exists
        if (apiKey) {
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // Save API Key
        document.getElementById('saveApiKey').addEventListener('click', () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-ant-')) {
                showError('Please enter a valid Anthropic API key (starts with sk-ant-)');
                return;
            }
            
            localStorage.setItem('anthropic_api_key', key);
            apiKey = key;
            
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        });

        // Change API Key
        document.getElementById('changeApiKey').addEventListener('click', () => {
            if (confirm('Change your API key? This will clear your current session.')) {
                localStorage.removeItem('anthropic_api_key');
                apiKey = null;
                document.getElementById('apiKeySection').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('apiKeyInput').value = '';
            }
        });

        // Reset AI System
        document.getElementById('resetML').addEventListener('click', () => {
            if (confirm('Reset all AI learning data? This will clear your preference history.')) {
                mlSystem.reset();
            }
        });

        // Genre selection
        document.querySelectorAll('.genre-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const genre = tag.dataset.genre;
                if (selectedGenres.includes(genre)) {
                    selectedGenres = selectedGenres.filter(g => g !== genre);
                    tag.classList.remove('selected');
                } else {
                    selectedGenres.push(genre);
                    tag.classList.add('selected');
                }
            });
        });

        // Get recommendations
        document.getElementById('getRecommendations').addEventListener('click', async () => {
            const favoriteMovies = document.getElementById('favoriteMovies').value.trim();
            const mood = document.getElementById('moodInput').value.trim();

            if (!favoriteMovies) {
                showError('Please enter at least 3 favorite movies');
                return;
            }

            userProfile = { favoriteMovies, genres: selectedGenres, mood };
            await getRecommendations(userProfile);
        });

        // Refine recommendations
        document.getElementById('refineFeedback').addEventListener('click', async () => {
            const feedback = document.getElementById('feedbackInput').value.trim();
            if (!feedback) return;

            await refineRecommendations(feedback);
            document.getElementById('feedbackInput').value = '';
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function cleanJsonResponse(text) {
            let cleaned = text.trim();
            cleaned = cleaned.replace(/^```json\s*/i, '');
            cleaned = cleaned.replace(/^```\s*/i, '');
            cleaned = cleaned.replace(/```\s*$/i, '');
            return cleaned.trim();
        }

        async function getRecommendations(profile) {
            showLoading();
            hideError();

            let basePrompt = `You are an expert movie critic and recommendation AI with deep knowledge of cinema across all genres and eras. Analyze the user's preferences carefully and provide 6 highly personalized, relevant movie recommendations.

User Profile:
- Favorite Movies: ${profile.favoriteMovies}
- Preferred Genres: ${profile.genres.join(', ') || 'Not specified'}
- Current Mood: ${profile.mood || 'Open to anything'}

ANALYSIS INSTRUCTIONS:
1. Identify the common themes, styles, and qualities in their favorite movies
2. Consider director styles, narrative structures, cinematography, and tone
3. Match their current mood with appropriate pacing and emotional tone
4. Balance between similar recommendations and thoughtful discoveries
5. Ensure diversity in your recommendations (different directors, years, sub-genres)
6. Prioritize movies they likely haven't seen but would love

QUALITY STANDARDS:
- Only recommend critically acclaimed or well-regarded films (IMDb 7.0+ preferred)
- Ensure each recommendation genuinely matches their stated preferences
- Provide specific, compelling reasons why each movie fits their taste
- Include accurate director names, years, and runtimes
- For streaming: Only include platforms where you have high confidence the movie is available

CRITICAL: For each movie, you MUST include:
- Accurate director name
- Correct release year
- Realistic runtime (in minutes)
- IMDb rating (if known, otherwise use general critical consensus rating)
- 2-3 streaming platforms where it's likely available

Available streaming platforms: "Netflix", "Amazon Prime", "Disney+", "HBO Max", "Hulu", "Apple TV+", "Paramount+", "Peacock"

RESPOND WITH ONLY VALID JSON (no markdown, no code blocks, no extra text):

{
  "reasoning": "2-3 sentences explaining your overall recommendation strategy based on their favorites",
  "recommendations": [
    {
      "title": "Exact Movie Title",
      "year": 2020,
      "genres": ["Genre1", "Genre2"],
      "rating": "8.5/10",
      "director": "Full Director Name",
      "runtime": "148 min",
      "description": "Compelling 2-sentence plot summary that hooks them",
      "whyRecommended": "Specific reason connecting to their favorite movies or stated preferences",
      "streamingOn": ["Netflix", "HBO Max"],
      "imdbRating": "8.5"
    }
  ]
}

EXAMPLE (for reference only - DO NOT copy):
If user likes "Inception, Interstellar, The Matrix":
- Recommend: Arrival (cerebral sci-fi), Blade Runner 2049 (visual sci-fi), Primer (complex narrative)
- Explain: "These films share Inception's mind-bending concepts and Interstellar's philosophical depth"
- Avoid: Generic action movies or films that don't match the intellectual sci-fi pattern

NOW PROVIDE 6 RECOMMENDATIONS FOR THIS USER:`;

            // Enhance prompt with AI insights
            const enhancedPrompt = mlSystem.getEnhancedPrompt(basePrompt);

            conversationHistory = [{ role: "user", content: enhancedPrompt }];

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2500,
                        messages: conversationHistory
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.content || !Array.isArray(data.content) || data.content.length === 0) {
                    throw new Error('Invalid API response structure');
                }
                
                const aiResponse = data.content[0].text;
                conversationHistory.push({ role: "assistant", content: aiResponse });

                const cleanedResponse = cleanJsonResponse(aiResponse);
                const recommendations = JSON.parse(cleanedResponse);
                
                if (!recommendations.reasoning || !Array.isArray(recommendations.recommendations)) {
                    throw new Error('Invalid recommendation structure');
                }
                
                currentRecommendations = recommendations.recommendations;
                displayRecommendations(recommendations);
            } catch (error) {
                console.error('Error details:', error);
                hideLoading();
                showError(`Failed to get recommendations: ${error.message}`);
            }
        }

        async function refineRecommendations(feedback) {
            showLoading();
            hideError();

            conversationHistory.push({
                role: "user",
                content: `User feedback: "${feedback}"

ANALYZE THIS FEEDBACK:
- What specific changes are they requesting?
- Which movies did they want more/less of?
- What patterns should you emphasize or avoid?

Provide 6 NEW recommendations (don't repeat previous suggestions) that incorporate this feedback while maintaining the quality standards:
- High-quality films (IMDb 7.0+)
- Accurate details (director, year, runtime)
- Specific connections to their preferences
- Diverse selection
- Include streaming platforms

Respond with ONLY valid JSON in the same format as before.`
            });

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2500,
                        messages: conversationHistory
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.content || !data.content[0]) {
                    throw new Error('Invalid API response');
                }
                
                const aiResponse = data.content[0].text;
                conversationHistory.push({ role: "assistant", content: aiResponse });

                const cleanedResponse = cleanJsonResponse(aiResponse);
                const recommendations = JSON.parse(cleanedResponse);
                
                currentRecommendations = recommendations.recommendations;
                displayRecommendations(recommendations);
            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showError(`Failed to refine recommendations: ${error.message}`);
            }
        }

        function displayRecommendations(data) {
            hideLoading();

            document.getElementById('recommendationReasoning').textContent = data.reasoning;
            
            const movieCards = document.getElementById('movieCards');
            movieCards.innerHTML = '';

            data.recommendations.forEach((movie, index) => {
                const card = document.createElement('div');
                card.className = 'movie-card glass-effect rounded-2xl p-6 shadow-xl';
                
                if (!movie.streamingOn) {
                    movie.streamingOn = [];
                }
                
                let streamingBadges = '';
                if (Array.isArray(movie.streamingOn) && movie.streamingOn.length > 0) {
                    streamingBadges = movie.streamingOn.map(platform => {
                        const platformInfo = streamingPlatforms[platform] || { 
                            color: 'bg-gray-600', 
                            name: platform,
                            textColor: 'text-white',
                            logo: null
                        };
                        return `
                            <div class="streaming-badge inline-flex items-center ${platformInfo.color} rounded-xl px-4 py-2.5 mr-2 mb-2 shadow-lg hover:shadow-xl border border-white/20">
                                ${platformInfo.logo ? `<img src="${platformInfo.logo}" alt="${platformInfo.name}" class="h-6 w-6 mr-2.5 object-contain" onerror="this.style.display='none'" />` : ''}
                                <span class="text-sm font-bold ${platformInfo.textColor} whitespace-nowrap">${platformInfo.name}</span>
                            </div>
                        `;
                    }).join('');
                }
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold text-blue-50 mb-1">${movie.title}</h3>
                            ${movie.director ? `<p class="text-blue-300 text-sm">Directed by ${movie.director}</p>` : ''}
                        </div>
                        <div class="flex flex-col items-end ml-4">
                            ${movie.imdbRating ? `
                            <div class="flex items-center px-3 py-1 bg-yellow-500/20 border border-yellow-400/50 rounded-lg mb-2">
                                <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="text-sm font-bold text-yellow-300">${movie.imdbRating}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center text-blue-200 text-sm mb-4 font-medium space-x-3">
                        <span>${movie.year}</span>
                        <span class="text-blue-400">‚Ä¢</span>
                        <span>${movie.genres.join(', ')}</span>
                        ${movie.runtime ? `
                        <span class="text-blue-400">‚Ä¢</span>
                        <span>${movie.runtime}</span>
                        ` : ''}
                    </div>
                    <p class="text-blue-100/90 mb-6 leading-relaxed">${movie.description}</p>
                    <div class="pt-4 border-t border-white/10 mb-4">
                        <p class="text-sm text-blue-200"><span class="font-semibold text-blue-300">Perfect for you:</span> ${movie.whyRecommended}</p>
                    </div>
                    
                    <!-- Rating Buttons -->
                    <div class="pt-4 border-t border-white/10 mb-4">
                        <p class="text-xs text-purple-300 mb-2 font-semibold">Help AI learn your taste:</p>
                        <div class="flex gap-2">
                            <button onclick="rateMovie(${index}, 1)" class="flex-1 px-4 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-400/50 rounded-lg text-sm font-semibold text-green-200 transition-all">
                                üëç Like
                            </button>
                            <button onclick="rateMovie(${index}, 0)" class="flex-1 px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/50 rounded-lg text-sm font-semibold text-red-200 transition-all">
                                üëé Dislike
                            </button>
                        </div>
                    </div>
                    
                    ${streamingBadges ? `
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-blue-300 mb-3 font-semibold flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Available on:
                        </p>
                        <div class="flex flex-wrap">
                            ${streamingBadges}
                        </div>
                    </div>
                    ` : `
                    <div class="pt-4 border-t border-white/10">
                        <p class="text-xs text-blue-300/60 italic flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Check JustWatch for streaming availability
                        </p>
                    </div>
                    `}
                `;
                movieCards.appendChild(card);
            });

            document.getElementById('recommendationsSection').classList.remove('hidden');
            document.getElementById('recommendationsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Rate movie function (global for onclick)
        window.rateMovie = function(index, rating) {
            const movie = currentRecommendations[index];
            if (movie) {
                mlSystem.rateMovie(movie.title, movie.genres, rating);
                
                // Visual feedback
                const buttons = event.target.parentElement.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                event.target.classList.add('opacity-50');
                event.target.innerHTML = rating === 1 ? '‚úì Liked' : '‚úì Noted';
                
                // Show toast
                showToast(rating === 1 ? 'Added to your preferences! üëç' : 'Noted your feedback! üëé');
            }
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('recommendationsSection').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
